# HSM (payShield10K) Command Tools

HSM（Hardware Security Module）payShield10Kのコマンドを実行するスタンドアロンPHPツールです。

## 概要

payShield10K HSMの各種コマンドを実行できます。主に以下の機能を提供します：

- **スワイプデータ生成**: クレジットカードの完全なスワイプデータを生成
- **スワイプデータパース**: 生成されたスワイプデータをパース
- **データ暗号化**: 任意のデータの暗号化
- **公開鍵インポート**: X.509形式のBase64エンコードされた公開鍵をHSMにインポート
- **公開鍵暗号化TMKエクスポート**: インポートされた公開鍵のMAC値を使用してTMKを公開鍵で暗号化してエクスポート
- **IPEK生成（TR-31形式）**: BDKとTMKを使用してIPEKを生成し、TR-31形式で出力
- **IPEK生成（形式未定）**: BDKとTMKを使用してIPEKを生成（後続処理でTR-34形式で出力する想定）
- **IPEKエクスポート（TR-34形式）**: DeriveIPEK.phpで生成されたIPEKと公開鍵を使用してIPEKをTR-34形式でエクスポート
- **データ復号化（CBCモード）**: 暗号化されたデータをCBCモードで復号化
- **キーコンポーネントからキー生成**: 2つのキーコンポーネントから新たなキーを生成（ZPK/ZEK対応）
- **PIN暗号化変換**: ZPKで暗号化されたPIN BlockをDUKPTの鍵(BDK)で暗号化されたPIN Blockに変換
- **PINブロックECB復号化**: 復号化キーで暗号化されたPIN BlockをECBモードで復号化し、オプションでPINを取得
- **データブロックECB復号化（BDK使用）**: BDKを使用してECBモードでデータブロックを復号化
- **TMK生成**: HSMを使用してTMK（Terminal Master Key）を生成
- **MAC生成**: HSMを使用してMAC値を生成（決済データの整合性検証に使用）
- **MAC検証**: HSMを使用してMAC値の検証を実行（決済データの整合性検証に使用）

## ファイル構成

```
HSMPaymentCrypto/
├── GenerateSwipeData.php    # スワイプデータ生成ツール
├── ParseSwipeData.php        # スワイプデータパーサー
├── Encrypt.php               # データ暗号化ツール
├── ImportPublicKey.php       # 公開鍵インポートツール
├── ExportTMKEncryptedByImportedPublicKey.php # 公開鍵暗号化TMKエクスポートツール
├── GenerateIPEKformattedTR31.php # IPEK生成ツール（TR-31形式）
├── DeriveIPEK.php            # IPEK生成ツール（形式未定）
├── ExportIPEKformattedTR34.php # IPEKエクスポートツール（TR-34形式）
├── DecryptCBC.php            # データ復号化ツール（CBCモード）
├── FormKeyFromEncryptedComponents.php # キーコンポーネントからキー生成ツール
├── TranslatePinFromEncryption.php # PIN暗号化変換ツール
├── DecryptECBforPIN.php     # PINブロックECB復号化ツール
├── DecryptECBwithBDK.php    # データブロックECB復号化ツール（BDK使用）
├── GenerateTMK.php          # TMK生成ツール
├── GenerateMAC.php          # MAC生成ツール
├── VerifyMAC.php             # MAC検証ツール
├── profile.php               # ユーザー設定ファイル
├── README.md                 # このファイル
└── src/                      # プログラムクラス群
    ├── HexUtil.php           # 16進数文字列操作ユーティリティ
    ├── HSMClient.php         # HSM接続クライアント
    ├── HSMCommandGenerator.php # HSMコマンド生成
    ├── HSMResponseParser.php   # HSMレスポンス解析
    ├── HSMSocketManager.php    # HSMソケット管理
    ├── EmvParser.php          # EMVデータパーサー
    ├── PublicKeyUtil.php      # 公開鍵ユーティリティ
    ├── PINUtil.php            # PIN復号化ユーティリティ
    └── property.php           # HSM接続設定（内部設定）
```

## 必要な環境と前提

- PHP 7.4以上
- HSMへのネットワーク接続
- 柔軟に生成結果を得るには入力設定のための前提知識が必要
  - 決済端末SDK仕様
  - EMV tag ([EMV® Specifications & Associated Bulletins](https://www.emvco.com/specifications/))

## ツール詳細

### 1. GenerateSwipeData.php

クレジットカードの完全なスワイプデータを生成するメインツールです。\
入力設定は`profile.php`に記述します。

#### 使用方法

##### IC処理（実装済み）

```bash
php GenerateSwipeData.php 1
```

##### MS処理（未実装）

```bash
php GenerateSwipeData.php 0
```

#### 出力例

```
swipe_data: 0201a45047303130021000000402015085018838c7ce613c6cd8ef2c622e02a456c323dc5d225176d41d68aeec90caee9b2cfdbd240b0f940a773c77333169f807b375667f33dfb3a369e2e29fdf268a6f29e85a4a86b8fc2f78de749a96fe1472102e0d6cb36029a594a86af6b42b2b237491400d86960c8b0f39e1fa2a69b5fd74e2ee8a741895c07a3f737a77312abc9b5c6aaa21edce45ae7cd8e9155fc1730305ada352324e53d5143e6fbf0891bedaac0904e162b2f93e7ee61d5e33974c2a1deb852e778bf142961c545ccf6499432814807ed45920966e6e0ec028c2e3e3a6e408755089bd59c9f93f2bd5b870a617eb1fc3d2ebf5975371237cf5fddb2eb4b3620330253b9cd7764b8cb7b63c1ec90300fe1bac76bb63191f238b6b5f23e12a04a4339e8efb570935cc0771209ec52b65275c88c79a7704c9c2999cf3eae4e76094fc60eb7fd1dc18dfde57c2e9bfcdf79951d23b69eec2846468010000003d5a08358746ffffff06925f300202015f200d545241494e494e4720434152445f280201569505088008e0005f24032708319f3303c0b8e89f34031e030000042cf561929703
```

#### 生成されるスワイプデータの構成

| フィールド | 説明 | 例 |
|-----------|------|-----|
| STX | 開始文字（0x02） | 02 |
| LEN0 | 全体の長さ（16進数4桁） | 01a4 |
| KSN | キーシリアル番号 | 50473031300210000004 |
| TransResult | 取引結果 | 02 |
| LEN1 | DATA1の長さ | 0201 |
| DATA1 | 暗号化されたEMVデータ | 5085018838c7ce... |
| LEN2 | DATA2の長さ | 0000 |
| LEN3 | DATA3の長さ | 003d |
| DATA3 | カード情報平文 | 5a08358746... |
| LEN4 | DATA4の長さ | 0004 |
| DATA4 | MAC値 | 2cf56192 |
| XOR | XORチェックサム | 97 |
| ETX | 終了文字（0x03） | 03 |

### 2. ParseSwipeData.php

GenerateSwipeData.phpの逆処理として、スワイプデータをパースするツールです。IC処理とMS（磁気カード）処理に対応しています。NUMフィールド（0x05）の有無で自動的にIC/MSを判別します。

#### 使用方法

```bash
php ParseSwipeData.php <swipeData>
```

#### パラメータ

- `swipeData`: パース対象のスワイプデータ（16進数文字列）

#### IC処理の実行例

```bash
php ParseSwipeData.php 0201845047303530000220053902013886e99969ba86497106843dda0bfc5fea927e2cfb6c469e76aa5fd80d55b97f3a0a867368908de7bf6e88503518153d9b8cfabddc48d9ecb6ef6b12f602b2d3277a4be3d561681d2595c6657f6f2d1acdb75043c25998cfd2f9d5acfbecba2ed38a7a0e1835999711489b55c2301a1fc3348a40c67d4dd32859ac91dac027c573aebfac841bca2bc26a2f4796b581f18f032e8bc58854ce5a64a3c1979596a26c87fa59c60cffb043c998ec7225ef0c256a9d06a5d8e48656942e78016eb1c5e8bd002bb5b4a7798fa4a25685309ab2f18363be52e02364a2329ced208ecf644466f64893b9918f2b2e24a47761db0c70404e197f3fdf6446ff9cd081f72c11d1b16ea4a1d66290727e1238264bf89bd46025e1fc21e247d15970efe667f14e4969fa1e4d3991ccb17f9bd64ca82dfd8476679348b7800433000000355a0a621094ffffffffff152f950504c00488005f200855494343465431355f24031010315f280201569f3303e0f8c89f340342030000041d69466acf03
```

#### IC処理の期待値

```
=== RESULT ===
STX: 02
LEN0: 0184 (388文字)
KSN: 50473035300002200539
TransResult: 02
LEN1: 0138 (312文字)
DATA1: 86e99969ba86497106843dda0bfc5fea927e2cfb6c469e76aa5fd80d55b97f3a0a867368908de7bf6e88503518153d9b8cfabddc48d9ecb6ef6b12f602b2d3277a4be3d561681d2595c6657f6f2d1acdb75043c25998cfd2f9d5acfbecba2ed38a7a0e1835999711489b55c2301a1fc3348a40c67d4dd32859ac91dac027c573aebfac841bca2bc26a2f4796b581f18f032e8bc58854ce5a64a3c1979596a26c87fa59c60cffb043c998ec7225ef0c256a9d06a5d8e48656942e78016eb1c5e8bd002bb5b4a7798fa4a25685309ab2f18363be52e02364a2329ced208ecf644466f64893b9918f2b2e24a47761db0c70404e197f3fdf6446ff9cd081f72c11d1b16ea4a1d66290727e1238264bf89bd46025e1fc21e247d15970efe667f14e4969fa1e4d3991ccb17f9bd64ca82dfd8476679348b7800433
LEN2: 0000 (0文字)
DATA2: 
LEN3: 0035 (53文字)
DATA3: 5a0a621094ffffffffff152f950504c00488005f200855494343465431355f24031010315f280201569f3303e0f8c89f3403420300
LEN4: 0004 (4文字)
DATA4: 1d69466a
XOR: cf
ETX: 03

=== DATA1復号化結果 ===
DATA1(復号化): 4f08a000000333010102500b554943432043524544495457136210948000000000152d10102200000000000f5a0a6210948000000000152f82027d008408a0000003330101028a0200008e0e000000000000000042031e031f00950504c00488009a032510069b02e8009c01005f200855494343465431355f24031010315f25030510315f280201565f2a0203925f300202205f3401009f02060000000015009f03060000000000009f0702ff009f080200309f090200209f0d05d8609ca8009f0e0500100000009f0f05d8689cf8009f100807000103a00000019f1a0203929f1e0836323030303539349f1f0e32303135303632353133323334359f21031601079f26080ec20be99e0bc0449f2701809f3303e0f8c89f34034203009f3501229f360200029f37042cd0d4569f41040000133700000000

=== DATA1 EMVパース結果 ===
Tag: 4f (Application Identifier (AID)) - Length: 8 - Value: a000000333010102
Tag: 50 (Application Label) - Length: 11 - Value: 5549434320435245444954
Tag: 57 (Track 2 Equivalent Data) - Length: 19 - Value: 6210948000000000152d10102200000000000f
Tag: 5a (Application Primary Account Number (PAN)) - Length: 10 - Value: 6210948000000000152f
Tag: 82 (Application Interchange Profile) - Length: 2 - Value: 7d00
Tag: 84 (Dedicated File (DF) Name) - Length: 8 - Value: a000000333010102
Tag: 8a (Authorization Response Code) - Length: 2 - Value: 0000
Tag: 8e (Cardholder Verification Method (CVM) List) - Length: 14 - Value: 000000000000000042031e031f00
Tag: 95 (Terminal Verification Results) - Length: 5 - Value: 04c0048800
Tag: 9a (Transaction Date) - Length: 3 - Value: 251006
Tag: 9b (Transaction Status Information) - Length: 2 - Value: e800
Tag: 9c (Transaction Type) - Length: 1 - Value: 00
Tag: 5f20 (Cardholder Name) - Length: 8 - Value: 5549434346543135
Tag: 5f24 (Application Expiration Date) - Length: 3 - Value: 101031
Tag: 5f25 (Application Effective Date) - Length: 3 - Value: 051031
Tag: 5f28 (Issuer Country Code) - Length: 2 - Value: 0156
Tag: 5f2a (Transaction Currency Code) - Length: 2 - Value: 0392
Tag: 5f30 (Service Code) - Length: 2 - Value: 0220
Tag: 5f34 (Application Primary Account Number Sequence Number) - Length: 1 - Value: 00
Tag: 9f02 (Amount, Authorised (Numeric)) - Length: 6 - Value: 000000001500
Tag: 9f03 (Amount, Other (Numeric)) - Length: 6 - Value: 000000000000
Tag: 9f07 (Application Usage Control) - Length: 2 - Value: ff00
Tag: 9f08 (Application Version Number) - Length: 2 - Value: 0030
Tag: 9f09 (Application Version Number) - Length: 2 - Value: 0020
Tag: 9f0d (Issuer Action Code - Denial) - Length: 5 - Value: d8609ca800
Tag: 9f0e (Issuer Action Code - Online) - Length: 5 - Value: 0010000000
Tag: 9f0f (Issuer Application Data) - Length: 5 - Value: d8689cf800
Tag: 9f10 (Issuer Application Data) - Length: 8 - Value: 07000103a0000001
Tag: 9f1a (Terminal Country Code) - Length: 2 - Value: 0392
Tag: 9f1e (Interface Device (IFD) Serial Number) - Length: 8 - Value: 3632303030353934
Tag: 9f1f (Track 1 Discretionary Data) - Length: 14 - Value: 3230313530363235313332333435
Tag: 9f21 (Transaction Time) - Length: 3 - Value: 160107
Tag: 9f26 (Application Cryptogram) - Length: 8 - Value: 0ec20be99e0bc044
Tag: 9f27 (Cryptogram Information Data) - Length: 1 - Value: 80
Tag: 9f33 (Terminal Capabilities) - Length: 3 - Value: e0f8c8
Tag: 9f34 (Cardholder Verification Method (CVM) Results) - Length: 3 - Value: 420300
Tag: 9f35 (Terminal Type) - Length: 1 - Value: 22
Tag: 9f36 (Application Transaction Counter (ATC)) - Length: 2 - Value: 0002
Tag: 9f37 (Unpredictable Number) - Length: 4 - Value: 2cd0d456
Tag: 9f41 (Transaction Sequence Counter) - Length: 4 - Value: 00001337

=== DATA3 EMVパース結果 ===
Tag: 5a (Application Primary Account Number (PAN)) - Length: 10 - Value: 621094ffffffffff152f
Tag: 95 (Terminal Verification Results (TVR)) - Length: 5 - Value: 04c0048800
Tag: 5f20 (Cardholder Name) - Length: 8 - Value: 5549434346543135
Tag: 5f24 (Application Expiration Date (YYMMDD)) - Length: 3 - Value: 101031
Tag: 5f28 (Issuer Country Code) - Length: 2 - Value: 0156
Tag: 9f33 (Terminal Capabilities) - Length: 3 - Value: e0f8c8
Tag: 9f34 (Cardholder Verification Method (CVM) Results) - Length: 3 - Value: 420300
```

#### MS（磁気カード）JIS1処理の実行例

```bash
php ParseSwipeData.php 0200B405007042684055AF987076D8D9CF51141E53E5B5F29C317F4E01FCFAA6A1EA4CD323EB781B5CA0E68B1CF64E1371C52BDC4DAC5ADA187098FF7BBA960EDE6F203249715E0ECC027B81D3D899AFB5068658BFCF98E2F7CA4101FC1AC90FDE3DBCEF992655B407669BACA19EACA97A8659C7756C00255A08498607FFFFFF31555F24032505315F300202015F20085A45524F2F504F535F28009500000A5047303130020F200003000000043332343000047DD2E02ABE03
```

#### MS（磁気カード）JIS1処理の期待値

```
=== RESULT ===
STX: 02
LEN0: 00b4 (180文字)
NUM: 05 (0x05 = MS)
LEN1: 0070 (112文字)
DATA1: 42684055af987076d8d9cf51141e53e5b5f29c317f4e01fcfaa6a1ea4cd323eb781b5ca0e68b1cf64e1371c52bdc4dac5ada187098ff7bba960ede6f203249715e0ecc027b81d3d899afb5068658bfcf98e2f7ca4101fc1ac90fde3dbcef992655b407669baca19eaca97a8659c7756c
LEN2: 0025 (37文字)
DATA2: 5a08498607ffffff31555f24032505315f300202015f20085a45524f2f504f535f28009500
LEN3: 000a (10文字)
DATA3 (KSN): 5047303130020f200003
KSN: 5047303130020f200003
LEN4: 00000004 (4文字)
DATA4 (RI): 33323430
LEN5: 0004 (4文字)
DATA5 (MAC): 7dd2e02a
XOR: be
ETX: 03

=== DATA1復号化結果 ===
DATA1(復号化): 0200683d2542343938363037393830383035333135355e5a45524f2f504f535e323530353230313030303030202020202020202030303635353030303030303f04283b343938363037393830383035333135353d32353035323031303030303036353530303030303f34001403800000

=== DATA1内部構造（磁気カードデータ）===
STX: 02
LEN0: 0068 (104文字)
LEN1: 3d (61文字)
DATA1 (JIS1 1st Track): 2542343938363037393830383035333135355e5a45524f2f504f535e323530353230313030303030202020202020202030303635353030303030303f04
--- JIS1 1st Track パース結果 (JIS1 1st Track Layout) ---
  STX: 25
  Format Code: 42
  Member ship Number: 34393836303739383038303533313535(4986079808053155)
  Separator1: 5e
  Holder Name: 5a45524f2f504f53(ZERO/POS)
  Separator2: 5e
  Expire Date: 2505
  Service Code: 201
  PIN Code: 00000
  Reserve: 20202020202020203030363535303030303030(        00655000000)
  ETX: 3f
  CRC: 04
LEN2: 28 (40文字)
DATA2 (JIS1 2nd Track): 3b343938363037393830383035333135353d32353035323031303030303036353530303030303f34
--- JIS1 2nd Track パース結果 (JIS1 2nd Track Layout) ---
  STX: 3b
  Member ship Number: 34393836303739383038303533313535(4986079808053155)
  Separator: 3d
  Expire Date: 2505
  Service Code: 201
  PIN: 00000
  Reserve: 3635353030303030(65500000)
  ETX: 3f
  CRC: 34
LEN3: 00 (0文字)
DATA3 (JIS2 Track): 
XOR: 14
ETX: 03

=== DATA2 EMVパース結果 ===
Tag: 5a (Application Primary Account Number (PAN)) - Length: 8 - Value: 498607ffffff3155
Tag: 5f24 (Application Expiration Date (YYMMDD)) - Length: 3 - Value: 250531
Tag: 5f30 (Service Code) - Length: 2 - Value: 0201
Tag: 5f20 (Cardholder Name) - Length: 8 - Value: 5a45524f2f504f53
Tag: 5f28 (Issuer Country Code) - Length: 0 - Value: 
Tag: 95 (Terminal Verification Results (TVR)) - Length: 0 - Value: 
```

> **注意**: MS処理では、DATA2がEMV形式の平文データとして格納されています。DATA1は暗号化された磁気カードデータ（内部に1st Track、2nd Track、JISII Trackを含む）で、復号化後に内部構造がパースされます。

#### MS（磁気カード）JIS2処理の実行例

```bash
php ParseSwipeData.php 0200920500585083EC2EA2AB371B48AA5CFFB8620AC414AB8102DF2B700DA10460F0A45BEECF3145483105CB8CACDD5841EB83CAA19525998210391D32F07ED1F87367C74C32C255FFE09B042604B591E20C596DEF566CE80F7F662C0CE3001B5A08498607FFFFFF31555F24032505315F30005F20005F28009500000A5047303130020F200004000000043332343000044E4B17FDA903
```

#### MS（磁気カード）JIS2処理の期待値

```
=== RESULT ===
STX: 02
LEN0: 0092 (146文字)
NUM: 05 (0x05 = MS)
LEN1: 0058 (88文字)
DATA1: 5083ec2ea2ab371b48aa5cffb8620ac414ab8102df2b700da10460f0a45beecf3145483105cb8cacdd5841eb83caa19525998210391d32f07ed1f87367c74c32c255ffe09b042604b591e20c596def566ce80f7f662c0ce3
LEN2: 001b (27文字)
DATA2: 5a08498607ffffff31555f24032505315f30005f20005f28009500
LEN3: 000a (10文字)
DATA3 (KSN): 5047303130020f200004
KSN: 5047303130020f200004
LEN4: 00000004 (4文字)
DATA4 (RI): 33323430
LEN5: 0004 (4文字)
DATA5 (MAC): 4e4b17fd
XOR: a9
ETX: 03

=== DATA1復号化結果 ===
DATA1(復号化): 02004b0000487f6139303030303936363434393836303739383038303533313535333031303030303030323430363235303530303030303030303030303030303030303030303036353938307f1236038000000000000000

=== DATA1内部構造（磁気カードデータ）===
STX: 02
LEN0: 004b (75文字)
LEN1: 00 (0文字)
DATA1 (JIS1 1st Track): 
LEN2: 00 (0文字)
DATA2 (JIS1 2nd Track): 
LEN3: 48 (72文字)
DATA3 (JIS2 Track): 7f6139303030303936363434393836303739383038303533313535333031303030303030323430363235303530303030303030303030303030303030303030303036353938307f12
--- JIS2 Track パース結果 (JIS2 Track Layout) ---
  STX: 
  ID Mark: a
  Biz Category Code: 9
  PIN Code: 0000
  Company Code: 9664
  Member ship Number: 34393836303739383038303533313535(4986079808053155)
  Arbitrary Data1: 3
  Arbitrary Data2: 0
  On/Off Flag: 1
  Reserve1: 30303030303032343036(0000002406)
  Expire Date: 2505
  Reserve2: 30303030303030303030303030303030303030303036353938(0000000000000000000006598)
  Validity Code: 0
  ETX: 
  CRC: 
XOR: 36
ETX: 03

=== DATA2 EMVパース結果 ===
Tag: 5a (Application Primary Account Number (PAN)) - Length: 8 - Value: 498607ffffff3155
Tag: 5f24 (Application Expiration Date (YYMMDD)) - Length: 3 - Value: 250531
Tag: 5f30 (Service Code) - Length: 0 - Value: 
Tag: 5f20 (Cardholder Name) - Length: 0 - Value: 
Tag: 5f28 (Issuer Country Code) - Length: 0 - Value: 
Tag: 95 (Terminal Verification Results (TVR)) - Length: 0 - Value:  
```

> **注意**: JIS2処理では、DATA1内部構造にJISII Trackデータのみが含まれ、1st Trackと2nd Trackは空です。JISII TrackはJIS2 Track Layoutに従ってパースされます。

### 3. コマンド検証用ツール

#### Encrypt.php (M0/M1)

任意のデータをHSMで暗号化するツールです。

##### 使用コマンド

[M0/M1] Encrypt Data Block

##### 使用方法

```bash
php Encrypt.php <plainText> <KSN>
```

##### 実行例

```bash
php Encrypt.php 4F08A000000333010102500B554943432043524544495457136210948000000000152D10102200000000000F5A0A6210948000000000152F82027D008408A0000003330101028A0200008E0E000000000000000042031E031F00950504C00488009A032510069B02E8009C01005F200855494343465431355F24031010315F25030510315F280201565F2A0203925F300202205F3401009F02060000000015009F03060000000000009F0702FF009F080200309F090200209F0D05D8609CA8009F0E0500100000009F0F05D8689CF8009F100807000103A00000019F1A0203929F1E0836323030303539349F1F0E32303135303632353133323334359F21031601079F26080EC20BE99E0BC0449F2701809F3303E0F8C89F34034203009F3501229F360200029F37042CD0D4569F41040000133700000000 50473035300002200539
```

##### 期待値

```
=== RESULT ===
KSN: 50473035300002200539
encryptedText: 86E99969BA86497106843DDA0BFC5FEA927E2CFB6C469E76AA5FD80D55B97F3A0A867368908DE7BF6E88503518153D9B8CFABDDC48D9ECB6EF6B12F602B2D3277A4BE3D561681D2595C6657F6F2D1ACDB75043C25998CFD2F9D5ACFBECBA2ED38A7A0E1835999711489B55C2301A1FC3348A40C67D4DD32859AC91DAC027C573AEBFAC841BCA2BC26A2F4796B581F18F032E8BC58854CE5A64A3C1979596A26C87FA59C60CFFB043C998EC7225EF0C256A9D06A5D8E48656942E78016EB1C5E8BD002BB5B4A7798FA4A25685309AB2F18363BE52E02364A2329CED208ECF644466F64893B9918F2B2E24A47761DB0C70404E197F3FDF6446FF9CD081F72C11D1B16EA4A1D66290727E1238264BF89BD46025E1FC21E247D15970EFE667F14E4969FA1E4D3991CCB17F9BD64CA82DFD8476679348B7800433D933625307998168
```

#### ImportPublicKey.php (EO/EP)

X.509形式のBase64エンコードされた公開鍵をHSMにインポートするツールです。公開鍵から実際の公開鍵データを抽出し、HSMにインポートしてMAC値を取得します。

##### 使用コマンド

[EO/EP] Import a Public Key

##### 使用方法

```bash
php ImportPublicKey.php <PublicKey>
```

##### パラメータ

- `PublicKey`: X.509形式のBase64エンコードされた公開鍵

##### 実行例

```bash
php ImportPublicKey.php MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAx1yuLfFLVheFEbWLITMyhnBplpGb3nNqXLfous+6/ZUc5Z19zwMQZqRaOU8D4MfwpBoWjF8jHVot3Pc+reFrnMyC9tc3DFQVwZoezJmTlBhAb3WDSlMfaqf6TxO7YLtQ5cbWqIgHJ4WPHfso8p1Ks7T7rtzvS/JhDhe4lnOhH/6M0xIrhp8fyr5EeJHxnIk6Jqa5f91UN3dYGcYi+I70pRm6uMti6bgSaitLqzIJzjK55zq/4PaMLljNI4/5nma77NXpl6ExC5PE9/3/f122sEOMPsFulH1LkKtKnI08b4hulL7o5kdTWxnZ8wWW/0HI/bhAKY3AQO4T/0crGHjd0QIDAQAB
```

##### 期待値

```
=== Import Public Key Tool ===
Public Key (Base64): MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAx1yuLfFLVheFEbWLITMyhnBplpGb3nNqXLfous+6/ZUc5Z19zwMQZqRaOU8D4MfwpBoWjF8jHVot3Pc+reFrnMyC9tc3DFQVwZoezJmTlBhAb3WDSlMfaqf6TxO7YLtQ5cbWqIgHJ4WPHfso8p1Ks7T7rtzvS/JhDhe4lnOhH/6M0xIrhp8fyr5EeJHxnIk6Jqa5f91UN3dYGcYi+I70pRm6uMti6bgSaitLqzIJzjK55zq/4PaMLljNI4/5nma77NXpl6ExC5PE9/3/f122sEOMPsFulH1LkKtKnI08b4hulL7o5kdTWxnZ8wWW/0HI/bhAKY3AQO4T/0crGHjd0QIDAQAB

Connected to HSM: tcp://192.168.8.202:1500
Send: 00001-EO020...
Receive: 00001-EP00S1030402RN00S00000...
Disconnected from HSM
=== RESULT ===
Public Key MAC (HEX): 5331303330343032524E303053303030303082010A0282010100C75CAE2DF14B56178511B58B21333286706996919BDE736A5CB7E8BACFBAFD951CE59D7DCF031066A45A394F03E0C7F0A41A168C5F231D5A2DDCF73EADE16B9CCC82F6D7370C5415C19A1ECC99939418406F75834A531F6AA7FA4F13BB60BB50E5C6D6A8880727858F1DFB28F29D4AB3B4FBAEDCEF4BF2610E17B89673A11FFE8CD3122B869F1FCABE447891F19C893A26A6B97FDD5437775819C622F88EF4A519BAB8CB62E9B8126A2B4BAB3209CE32B9E73ABFE0F68C2E58CD238FF99E66BBECD5E997A1310B93C4F7FDFF7F5DB6B0438C3EC16E947D4B90AB4A9C8D3C6F886E94BEE8E647535B19D9F30596FF41C8FDB840298DC040EE13FF472B1878DDD10203010001DDA432373242433535443044373142423344
```

> **注意**: 出力される公開鍵MAC値は16進数文字列として出力されます。この値は`ExportTMKEncryptedByImportedPublicKey.php`で使用されます。

##### 機能説明

- **公開鍵インポート**: X.509形式のBase64エンコードされた公開鍵をHSMにインポート
- **公開鍵抽出**: `PublicKeyUtil.php`を使用してX.509形式から実際の公開鍵データを抽出
- **MAC値取得**: HSMから公開鍵MAC値を取得（16進数文字列として出力）
- **DER形式対応**: DER形式の公開鍵データを抽出

> **注意**: 公開鍵MAC値は後続の処理（`ExportTMKEncryptedByImportedPublicKey.php`）で使用されます。

#### ExportTMKEncryptedByImportedPublicKey.php (GK/GL)

インポートされた公開鍵のMAC値を使用して、TMKを公開鍵で暗号化してエクスポートするツールです。

##### 使用コマンド

[GK/GL] Export Key under an RSA Public Key

##### 使用方法

```bash
php ExportTMKEncryptedByImportedPublicKey.php <PublicKeyMAC>
```

##### パラメータ

- `PublicKeyMAC`: 公開鍵MAC値（16進数文字列）

##### 実行例

```bash
php ExportTMKEncryptedByImportedPublicKey.php 5331303330343032524E303053303030303082010A0282010100C75CAE2DF14B56178511B58B21333286706996919BDE736A5CB7E8BACFBAFD951CE59D7DCF031066A45A394F03E0C7F0A41A168C5F231D5A2DDCF73EADE16B9CCC82F6D7370C5415C19A1ECC99939418406F75834A531F6AA7FA4F13BB60BB50E5C6D6A8880727858F1DFB28F29D4AB3B4FBAEDCEF4BF2610E17B89673A11FFE8CD3122B869F1FCABE447891F19C893A26A6B97FDD5437775819C622F88EF4A519BAB8CB62E9B8126A2B4BAB3209CE32B9E73ABFE0F68C2E58CD238FF99E66BBECD5E997A1310B93C4F7FDFF7F5DB6B0438C3EC16E947D4B90AB4A9C8D3C6F886E94BEE8E647535B19D9F30596FF41C8FDB840298DC040EE13FF472B1878DDD10203010001DDA432373242433535443044373142423344
```

##### 期待値

```
=== Export TMK Encrypted by Public Key Tool ===
Public Key MAC (HEX): 5331303330343032524E303053303030303082010A02820101...

Connected to HSM: tcp://192.168.8.202:1500
Send: 00001-GK0102010100;FFFFFS1009651TB00S000037B591D7EE516769C656FBF603B9EF7A4121DB4BC3524E267F1C4C7F31DF0B44FF17EABD9EE2D68F2020A20000000000S1030402RN00S00000...
Receive: 00001-GL000256...
Disconnected from HSM
=== RESULT ===
暗号化TMK: o1qHg85prHDMVy5fTvw8ww/8ROVmRphwc0Wk15KazlZMIgaoBsrXqjgZqRMDxr2nhGgGineGYugt0PzRm4YpST2K6/fS8qp8o1rqPEzjtFBi5wZlUFhb6DaXfNc5AVL3elPpBitirjD7XDcS5+Ujnhd5gKsxnpSSbG4UFJx9SFvrDZp5Xanz3mXx4nfU9rP4+K9R6QzawK8kXDfmmhtpetlARTV/3XUIXiUQlTI7dI62iG+VaDMkeOpPd0JehMcqiFpR3JITuhn7EsFhiDB/HR3wzEGPm9duSgoERHQyksnKywH0U0SBV09ZLfjNyOxQPG4zMGonKDpby/lVZ08GBQ==
```

> **注意**: 生成される暗号化TMKは毎回異なります。上記は実行例であり、実際の出力は実行のたびに変わります。出力はBase64エンコードされた暗号化TMKです。

##### (参考)復号化TMKの取得

登録した公開鍵のペアとなる秘密鍵およびそのパスワードを用いて、暗号化メッセージを復号化してTMKを取得することができます。

```
echo "o1qHg85prHDMVy5fTvw8ww/8ROVmRphwc0Wk15KazlZMIgaoBsrXqjgZqRMDxr2nhGgGineGYugt0PzRm4YpST2K6/fS8qp8o1rqPEzjtFBi5wZlUFhb6DaXfNc5AVL3elPpBitirjD7XDcS5+Ujnhd5gKsxnpSSbG4UFJx9SFvrDZp5Xanz3mXx4nfU9rP4+K9R6QzawK8kXDfmmhtpetlARTV/3XUIXiUQlTI7dI62iG+VaDMkeOpPd0JehMcqiFpR3JITuhn7EsFhiDB/HR3wzEGPm9duSgoERHQyksnKywH0U0SBV09ZLfjNyOxQPG4zMGonKDpby/lVZ08GBQ==" \
| base64 -d \
| openssl pkeyutl -decrypt \
  -inkey <(cat <<'PEM'
-----BEGIN ENCRYPTED PRIVATE KEY-----
MIIFLTBXBgkqhkiG9w0BBQ0wSjApBgkqhkiG9w0BBQwwHAQIHeeWxIWfVhwCAggA
MAwGCCqGSIb3DQIJBQAwHQYJYIZIAWUDBAEqBBCQC4bvpxLVy29qFllHEoYbBIIE
0Jr0yrllio7doxl5/uK3FOQ8fnVAd/srTasjGjVtu64mpNSa/J4rMghdk4bXC7uw
p1hSRmk2gOhqdOri6faN6Inij+86IWKFbyuuoRO43nwKMYHAHTdKfU4Yyeg9MkZA
PWr9bfzQioAoL3ZVOm+GXIAdSGoK4O21oJTEnbpMXI2p2hfV2PS2kTIfl2uIm/Wp
D6/lpb9vkA/FXf43UjcpPOcAWBi/D0EIdTnALHRW+K6Uw3d1dKF3/U78VHufHaab
2AoWnIFM9sdRj3ryrIdg+0wZP+RUDjitUiFLw4KmufW/FZutPxrsWhCs9q/zUzx+
gIRZow6LEGrBFo3DDOB3C53saZTAfUSVCO5zBnlrM6V/emhkk3ah0Z5xgGvWKDb1
vzC7JvSPSKxQtGzS+yEkOBIdb7Uww236ptXECRQnUbevOaxdbZ1vbtk6VCsWpxXl
GPzsP6MlOp2u6Jy21YM7N2oMTld/u5rxcEPH51Yuon2SG6bqFxdq1iFj69a+CDJ4
dRSooedZq65F2Z3FwH7f37QqoJLAdYp/Fy425kSE6QylMFMKNN7+GGtnh0wvloAI
feA85tHwbZXchRSGSYZmvwKjGnFEvCas1lUb63z7G/NP+55ozIH7Dr8V4kNvRX6x
D8T4t07/0dulFE8LYOcnvIarH9i0Ey3+/2uCsR1JQBLK2a79IHvyeH+V0u/pdkUY
IN0fZKIGjKU19+93kDxj3SD8/qdJnh4VnOZ5OtTerxT3TgkF4UT5fqbhLNJW4V0v
xFivLlG+So0wEjpoqdNJPcd0ORdN4FTKgGjcSZvkbPnAJts0frWbzIVNTmg9+Tp5
2VZRoDax1O2Y021G1IXDqn2BNDD1xuPB/ec1lOAxPBYFpp/U2Ti3NTGqwwAfilJl
FQDAQScWrU2NHHh4dC2VzBBXrAPPkfiZBMDc4YmCpWGNR0QCgD/Gb6ZNKPpFbJ96
2l7daWGr4L9DlGbNYbnYAztZoY/LVX/2tN95YRpNXDLhDXgxbhOVNy0FVoWyBQL8
wS46nHyPau5cacn11kpBr02o9pDRtHjCURRXymy3WOxRYwchX3PkntwB0+9zWLTV
RNCAfqO5A7dSRjtiIfJqWK3JkGt477cPd0OGqbNnq9NikO/yY31VEzK4d2sGP3VE
pHI+FTUle3SBiDMVZAdinPpwjWwHG95eeihD2EbgOmwAu1vX4VnzfksD63hM0OT4
UqZda27/m4P5K4ZMLgshH/Juj+WtoHGaNZpC4tzR0xUwJ/878wVF6S64qKv1VCW7
elkrh+BvseL1EXVgsm9p+GvnflDmDc86V2SRcr4AqNDmI8KNQKWQrZKQQyMDdaAl
EESli8gSSwrh02v+W9U8wkIPzfz6mHLoPlehzo9Xr3M6RHyUGTocV5K5ILZebTgP
wFn2ZruDL/grBApLA9+2qvq5nlGwL1jaUcGvtNEPvLamzxcuMrQKDv9FMXiEkBDz
RxcRe1UYNx4TPD7OiwNdQ3QSlG6q+9BkhPI4BG6CYYyjIV2hmga0KX8qGECcrmh4
ArbgmCgn70BBe5W3rBnqPekzN/hgeBEoPCtA6JRQP36luQfyHVD30MDuyLgVZiRP
MEHmCKYHUj4CourIU2Cc6pCvLbnHM7x89jIWGTw0kjEo
-----END ENCRYPTED PRIVATE KEY-----
PEM
) \
  -passin pass:password \
  -pkeyopt rsa_padding_mode:oaep \
| xxd -p -c 256
```

##### 機能説明

- **TMK暗号化エクスポート**: インポートされた公開鍵のMAC値を使用してTMKを公開鍵で暗号化
- **RSA暗号化**: RSA公開鍵を使用したOAEP方式での暗号化
- **Base64出力**: 暗号化されたTMKをBase64エンコードして出力
- **16進数入力**: 公開鍵MAC値は16進数文字列として入力（内部でバイナリに変換）

> **注意**: このツールは`ImportPublicKey.php`で取得した公開鍵MAC値を使用します。`src/property.php`の`tmk_block`と`tmk_mac`を使用してTMKを暗号化します。

#### GenerateIPEKformattedTR31.php (A0)(mode:B)

IPEK（Initial PIN Encryption Key）を生成するツールです。BDKとTMKを使用してIPEKを生成し、TR-31形式で出力します。本ツールはTR-31形式のIPEKを生成します。TR-34形式のIPEKが必要な場合は別途対応ツールを使用してください。

##### 使用コマンド

[A0] Derive & Export a Key (mode:B)

##### 使用方法

```bash
php GenerateIPEKformattedTR31.php <IKSN>
```

##### パラメータ

- `IKSN`: Initial Key Serial Number（15文字の16進数）

##### 実行例

```bash
php GenerateIPEKformattedTR31.php 504730313000002
```

##### 期待値

```
=== IPEK Generation Tool (TR-31 Format) ===
IKSN: 504730313000002

Connected to HSM: tcp://192.168.8.202:1500
Send: 00001-A0BFFFS01S10096B0TN00S0000FD2196304A9F78B4844B0719E4DFBACD97ABA9E94A05EFB3BFD3F754CC626643675DE7D3A50FBE45504730313000002S1009651TB00S000037B591D7EE516769C656FBF603B9EF7A4121DB4BC3524E267F1C4C7F31DF0B44FF17EABD9EE2D68FR#B1T2N00S00&N!B
Receive: 00001-A100S10096B1TN00S0000D4F66BEE64672EC4390604494FA164E521E11A27F2141D2593BAA960E14580ACF4473DCDCD4BC13BRB0080B1TN00N00003FD3AE994EB3971D9C6A091A846F09A171359CA6E985DA6F415564A61D2ECF87C49891
Disconnected from HSM
=== RESULT ===
ipekTr31: RB0080B1TN00N00003FD3AE994EB3971D9C6A091A846F09A171359CA6E985DA6F415564A61D2ECF87
kcv: C49891
```

> **注意**: 生成されるIPEKとKCVは毎回異なります。上記は実行例であり、実際の出力は実行のたびに変わります。IPEKはTR-31形式（`RB0080B1TN00N0000...`で始まる）で出力され、KCVは6文字の16進数で出力されます。

##### 機能説明

- **IPEK生成（TR-31形式）**: BDKとTMKを使用してIPEK（Initial PIN Encryption Key）を生成し、TR-31形式で出力
- **DUKPT対応**: IKSNを使用したDUKPTキー派生に対応
- **TR-31形式**: 標準的なキーブロック形式（TR-31）でIPEKを出力
- **KCV生成**: キーの整合性検証用のKCV（Key Check Value）を生成
- **キー管理**: `src/property.php`のBDKとTMKを使用

> **注意**: BDKは`src/property.php`の`bdk_block_3des`、TMKは`src/property.php`の`tmk_block`から取得されます。本ツールはTR-31形式のIPEKを生成します。TR-34形式のIPEKが必要な場合は別途対応ツールを使用してください。

#### DeriveIPEK.php (A0)(mode:B)

IPEK（Initial PIN Encryption Key）を生成するツールです。BDKとTMKを使用してIPEKを生成します。生成されたIPEKの形式は定まっておらず、後続処理でTR-34形式で出力する想定です。

##### 使用コマンド

[A0] Derive & Export a Key (mode:B)

##### 使用方法

```bash
php DeriveIPEK.php <IKSN>
```

##### パラメータ

- `IKSN`: Initial Key Serial Number（15文字の16進数）

##### 実行例

```bash
php DeriveIPEK.php 504730313000002
```

##### 期待値

```
=== IPEK Derivation Tool ===
IKSN: 504730313000002

Connected to HSM: tcp://192.168.8.202:1500
Send: 00001-A0BFFFS01S10096B0TN00S0000FD2196304A9F78B4844B0719E4DFBACD97ABA9E94A05EFB3BFD3F754CC626643675DE7D3A50FBE45504730313000002S1009651TB00S000037B591D7EE516769C656FBF603B9EF7A4121DB4BC3524E267F1C4C7F31DF0B44FF17EABD9EE2D68F%00
Receive: 00001-A100S10096B1TN00S0000...C49891
Disconnected from HSM
=== RESULT ===
ipek: S10096B1TN00S0000D4F66BEE64672EC4390604494FA164E5F119D855A47DCC06AFC621B11BE01FAD8B7921A6598D8C44
kcv: C49891
```

> **注意**: 生成されるIPEKとKCVは毎回異なります。上記は実行例であり、実際の出力は実行のたびに変わります。IPEKの形式は未定で、後続処理でTR-34形式で出力する想定です。KCVは6文字の16進数で出力されます。

##### 機能説明

- **IPEK生成**: BDKとTMKを使用してIPEK（Initial PIN Encryption Key）を生成
- **DUKPT対応**: IKSNを使用したDUKPTキー派生に対応
- **形式未定**: 生成されたIPEKの形式は定まっておらず、後続処理でTR-34形式で出力する想定
- **KCV生成**: キーの整合性検証用のKCV（Key Check Value）を生成
- **キー管理**: `src/property.php`のBDKとTMKを使用

> **注意**: BDKは`src/property.php`の`bdk_block_3des`、TMKは`src/property.php`の`tmk_block`から取得されます。生成されたIPEKの形式は未定で、後続処理でTR-34形式で出力する想定です。

#### ExportIPEKformattedTR34.php (B8/B9)

IPEKをTR-34形式でエクスポートするツールです。DeriveIPEK.phpで生成されたIPEKと公開鍵を使用してIPEKをTR-34形式でエクスポートします。

##### 使用コマンド

[B8/B9] Export Key under an RSA Public Key (TR-34 Format)

##### 使用方法

```bash
php ExportIPEKformattedTR34.php <IPEK> <PublicKey>
```

##### パラメータ

- `IPEK`: IPEK（形式未定、DeriveIPEK.phpで生成されたIPEK）
- `PublicKey`: X.509形式のBase64エンコードされた公開鍵

##### 実行例

```bash
php ExportIPEKformattedTR34.php S10096B1TN00S0000D4F66BEE64672EC4390604494FA164E5F119D855A47DCC06AFC621B11BE01FAD8B7921A6598D8C44 MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAyZoOuZt0oR/lgaNu/aIiBzLNcWYY8siO94v0jUUcJyEFiBQo7BPkZ8jur2+AaxFbKa49Pz5uzZ3ZSQLCFI76lopG9T/ANPc+rKE+PqFjzWIFzIRNdYjdXM0l3g4h6c6biKi9gsRuNPEjq2Dr6ConkJGiyz9yQ9eD1yCNwF43UWGEgxLgsbN9goFJLnBedhuneLKvR5wf6UYOikAVj3u/ln99Rn4HZ8EtwkdeJbNbw19M39IaiJznFPgyzpLua3gdPz6cR7VgVVVVMgsgQWTKmA1rUoIPvaeCUbNn9iWvDsSrf/uETO0fzMndX/7HH8nyUoa8L1JlaqYxf/xsLFxtlQIDAQAB
```

##### 期待値

```
=== IPEK Export Tool (TR-34 Format) ===
IPEK: S10096B1TN00S0000D4F66BEE64672EC4390604494FA164E5F...
Public Key (Base64): MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAyZoOuZt0oR/lgaNu/aIiBzLNcWYY8siO94v0jUUcJyEFiBQo7BPkZ8jur2+AaxFbKa49Pz5uzZ3ZSQLCFI76lopG9T/ANPc+rKE+PqFjzWIFzIRNdYjdXM0l3g4h6c6biKi9gsRuNPEjq2Dr6ConkJGiyz9yQ9eD1yCNwF43UWGEgxLgsbN9goFJLnBedhuneLKvR5wf6UYOikAVj3u/ln99Rn4HZ8EtwkdeJbNbw19M39IaiJznFPgyzpLua3gdPz6cR7VgVVVVMgsgQWTKmA1rUoIPvaeCUbNn9iWvDsSrf/uETO0fzMndX/7HH8nyUoa8L1JlaqYxf/xsLFxtlQIDAQAB

Connected to HSM: tcp://192.168.8.202:1500
Send: 00001-B80FFFS10096B1TN00S0000D4F66BEE64672EC4390604494FA164E5F119D855A47DCC06AFC621B11BE01FAD8B7921A6598D8C440E0-1
Receive: 00001-B9001
Disconnected from HSM
=== RESULT ===
ipekTr34: 020100318201E2308201DE02010030818D3079310B3009060355040613024A5031153013060355040A0C0C4578616D706C6520436F727031193017060355040B0C105061796D656E74205365637572697479310E300C06035504080C05546F6B796F3110300E06035504070C07436869796F64613116301406035504030C0D4B44482049737375657220303102103A9FB24C11DE77889900AA5566778890304506092A864886F70D0101073038300D06096086480165030402010500301806092A864886F70D010108300B0609608648016503040201300D06092A864886F70D0101090400048201008DEC8BB1ADD91F440DBC34F85774823D86B5F5A3C317C9E57A5DAE0FBD3243EEEBCB5BE48DAE0F9DB128662BF4AA8CFC18E47C4CD524001DD9D7D8447CDD0307FA0B133704845B3F2AF82C6A0351CEAEC9724133F6BA08AC5325ABC548A9715F71902080D89833475C19DFC3A44304F53DB8BF2FF89F94CF71E9E59CF055818588E96D11E7A9CBF42DB157C3D511F765D894289F8DBE70E96AEB482BDE2AEBD3A8A663B9B1D2576667A8709267CF7B7AC896C2756E5E86C9E22F8882216C9600A64A9B3ABA7343187E56F0DBBBF99E1A5A222AEFB193BF738636BC7C108AC9BE7EC469F03CB42D2D04674210924C366D7CC46AD75646EB8E2CB5FB06F146270B3081A506092A864886F70D01070130819706082A864886F70D03070408054508AC16E698628081805764D9A1AC60396E68A5C725F9B9B23F4646B73DE37E2AE32E41969AA50E27297993CE03F7214CDEB79677B21B33E78B8A41FD468EA5A1DA5B51CB69227128B2719781CA65D2955A11BFA3185981260397694628971E814976782F89F5991806027E4E072106D800AF22BCD007922EFF1467D102EE1FC69C75D8D38202A0D9C7
kcv: C49891
signature: 227EE5904C81D577DE3097377F1010D55AA98E99D80CD7141769B8AAE18953BEFFF5D7474D74E5E3575E2365A7D8C5D74C3D93AA674DFF6FE73A7118373B911FB0C6360FFF34431A57BD8663FEF5F846FD79972C173A3EF42BF204641022303C34CE2A2A15A32618940B14D12320777A1D1FF6C62AD08B65BC9E404471F3E73DDEAB0960443ED890571E1C7BC49FB811BA6DBFE02D95A3AD12644B34D2876B2B57317487F07A0D92C21CDCE1B0BFF33CA972BF14C93188281AA0A404E54B7D0148C8415D50D641BBE16EBA9E987248EBA7E60A8E99A178C8854A694A774AE5F1D4AE749B180E2A553B6D925569221061396FF3886BA66123C8235874422212C3
```

> **注意**: 生成されるIPEK(TR-34形式)、KCV、Signatureは毎回異なります。上記は実行例であり、実際の出力は実行のたびに変わります。IPEKはTR-34形式で出力され、KCVは6文字の16進数で出力されます。SignatureはHEX文字列で出力されます。

##### 機能説明

- **IPEKエクスポート（TR-34形式）**: DeriveIPEK.phpで生成されたIPEKと公開鍵を使用してIPEKをTR-34形式でエクスポート
- **公開鍵暗号化**: RSA公開鍵を使用したTR-34形式でのIPEKエクスポート
- **TR-34形式**: 標準的なキー交換形式（TR-34）でIPEKを出力
- **KCV生成**: キーの整合性検証用のKCV（Key Check Value）を生成
- **Signature生成**: Authenticated Attributesに対する署名を生成

> **注意**: このツールは`DeriveIPEK.php`で生成されたIPEKを使用します。公開鍵はX.509形式のBase64エンコードされた公開鍵を指定します。IPEKはTR-34形式で出力され、Enveloped DataとしてBERエンコードされた構造で含まれます。

#### DecryptCBC.php (M2/M3)

暗号化されたデータを復号化するツールです。

##### 使用コマンド

[M2/M3] Decrypt Data Block

##### 使用方法

```bash
php DecryptCBC.php <encryptedText> <KSN>
```

##### 実行例

```bash
php DecryptCBC.php 86E99969BA86497106843DDA0BFC5FEA927E2CFB6C469E76AA5FD80D55B97F3A0A867368908DE7BF6E88503518153D9B8CFABDDC48D9ECB6EF6B12F602B2D3277A4BE3D561681D2595C6657F6F2D1ACDB75043C25998CFD2F9D5ACFBECBA2ED38A7A0E1835999711489B55C2301A1FC3348A40C67D4DD32859AC91DAC027C573AEBFAC841BCA2BC26A2F4796B581F18F032E8BC58854CE5A64A3C1979596A26C87FA59C60CFFB043C998EC7225EF0C256A9D06A5D8E48656942E78016EB1C5E8BD002BB5B4A7798FA4A25685309AB2F18363BE52E02364A2329CED208ECF644466F64893B9918F2B2E24A47761DB0C70404E197F3FDF6446FF9CD081F72C11D1B16EA4A1D66290727E1238264BF89BD46025E1FC21E247D15970EFE667F14E4969FA1E4D3991CCB17F9BD64CA82DFD8476679348B7800433D933625307998168 50473035300002200539
```

##### 期待値

```
=== RESULT ===
decryptedText: 4f08a000000333010102500b554943432043524544495457136210948000000000152d10102200000000000f5a0a6210948000000000152f82027d008408a0000003330101028a0200008e0e000000000000000042031e031f00950504c00488009a032510069b02e8009c01005f200855494343465431355f24031010315f25030510315f280201565f2a0203925f300202205f3401009f02060000000015009f03060000000000009f0702ff009f080200309f090200209f0d05d8609ca8009f0e0500100000009f0f05d8689cf8009f100807000103a00000019f1a0203929f1e0836323030303539349f1f0e32303135303632353133323334359f21031601079f26080ec20be99e0bc0449f2701809f3303e0f8c89f34034203009f3501229f360200029f37042cd0d4569f410400001337000000008000000000000000
```

> **注意**: 復号化結果の末尾にパディングデータ（`8000000000000000`）が含まれます。これはCBCモードの復号化における正常な動作です。

#### FormKeyFromEncryptedComponents.php (A4/A5)

2つのキーコンポーネントから新たなキーを生成するツールです。ZPK（Zone PIN Key）やZEK（Zone Encryption Key）などの生成に使用されます。

##### 使用コマンド

[A4/A5] Form Key from Encrypted Components

##### 使用方法

```bash
php FormKeyFromEncryptedComponents.php <keyType>
```

##### パラメータ

- `keyType`: 生成するキーの種類
  - `zpk`: ZPK (Zone PIN Key) を生成
  - `zek`: ZEK (Zone Encryption Key) を生成

##### 実行例

```bash
# ZPKを生成
php FormKeyFromEncryptedComponents.php zpk

# ZEKを生成
php FormKeyFromEncryptedComponents.php zek
```

##### 期待値

```bash
=== Form Key from Encrypted Components Tool ===
Key Type: ZPK

Connected to HSM: tcp://192.168.8.202:1500
Send: 00001-A42FFFSS10096P0TNc1S0000816322732222F2BAA5F86DD0FEAED1CC16B9E691DE42682F89BFD0C630B853DEE46C8D24A7883E7FS10096P0TNc1S00003E325E7C8C60B6DF5CB6D37A95F64902795837374D9A1309B6ED6DBFC504A8ED1C625C3A6312A0AC%00
Receive: 00001-A500S10096P0TN00S0000D76AC3B0402D799DA896E731FF7F98A6B5E7A90825B1A1B2E4561238B26F150E9CA1E39022D03AE9...
Disconnected from HSM
=== RESULT ===
Generated Key: S10096P0TN00S0000D76AC3B0402D799DA896E731FF7F98A6B5E7A90825B1A1B2E4561238B26F150E9CA1E39022D03AE9...
```

> **注意**: 生成されるキーは毎回異なります。上記は実行例であり、実際の出力は実行のたびに変わります。キーはTR-31形式（`S10096P0TN00S0000...`で始まる）で出力されます。

##### 機能説明

- **キー生成**: HSMを使用して2つのキーコンポーネントから新しいキーを生成
- **ZPK/ZEK対応**: 引数でZPKまたはZEKの生成を選択可能
- **キーコンポーネント管理**: `src/property.php`に定義されたキーコンポーネントを使用
- **16進数デコード**: HSMからの応答を16進数文字列からデコードして出力
- **TR-31形式**: 標準的なキーブロック形式（S10096...）で出力

> **注意**: キーコンポーネントは`src/property.php`の`key_components`セクションに定義されています。ZPKは`zpk.kc1`と`zpk.kc2`から、ZEKは`zek.kc1`と`zek.kc2`から生成されます。

#### TranslatePinFromEncryption.php (G0/G1)

ZPK（Zone PIN Encryption Key）で暗号化されたPIN BlockをDUKPTの鍵(BDK)で暗号化されたPIN Blockに変換するツールです。

##### 使用コマンド

[G0/G1] Translate a PIN from BDK to BDK or ZPK Encryption (3DES & AES DUKPT)

##### 使用方法

```bash
php TranslatePinFromEncryption.php <ZPK> <KSN> <PINBlock> <AccountNumber>
```

##### パラメータ

- `ZPK`: Zone PIN Encryption Key（TR-31形式のキーブロック）
- `KSN`: Key Serial Number（20文字の16進数）
- `PINBlock`: 暗号化されたPIN Block（16文字の16進数）
- `AccountNumber`: アカウント番号（12桁の数字）

##### 実行例

```bash
php TranslatePinFromEncryption.php S10096P0TN00S0000D76AC3B0402D799DA896E731FF7F98A6FBAC138825AA477BC999928DDB4130F7B5D987A31CC0B3C4 5047303130020F200008 22828CA4BC2EA212 094800000003
```

##### 期待値

```bash
=== Translate PIN from Encryption Tool ===
ZPK: S10096P0TN00S0000D76AC3B0402D799DA896E731FF7F98A6FBAC138825AA477BC999928DDB4130F7B5D987A31CC0B3C4
KSN: 5047303130020F200008
PIN Block: 22828CA4BC2EA212
Account Number: 094800000003

Connected to HSM: tcp://192.168.8.202:1500
Send: 00001-G0S10096B0TN00S0000FD2196304A9F78B4844B0719E4DFBACD97ABA9E94A05EFB3BFD3F754CC626643675DE7D3A50FBE45S10096P0TN00S0000D76AC3B0402D799DA896E731FF7F98A6FBAC138825AA477BC999928DDB4130F7B5D987A31CC0B3C4A055047303130020F20000822828CA4BC2EA2120101094800000003%00
Receive: 00001-G1001038E557F9D0C2BFEE01
Disconnected from HSM
=== RESULT ===
Destination PIN Block: 38E557F9D0C2BFEE
```

##### 機能説明

- **PIN暗号化変換**: ZPKで暗号化されたPIN BlockをDUKPTの鍵(BDK)で暗号化されたPIN Blockに変換
- **暗号化方式変換**: 異なる暗号化キー間でのPIN Block変換に対応
- **16進数文字列入出力**: 入力・出力ともに16進数文字列形式
- **TR-31キー形式対応**: ZPKはTR-31形式のキーブロック形式に対応

#### DecryptECBforPIN.php (M2/M3)

PINブロックをECBモードで復号化するツールです。復号化キーで暗号化されたPIN Blockを復号化し、オプションでPANを指定することでPINを取得できます。

##### PIN取得の流れ（XOR処理）

PANと復号化されたPINデータからPINを取得する処理の概要：

1. **復号化PINデータからPIN Block DUKPTを抽出**
   - 復号化されたPINデータの最初の4文字（16進数）がメッセージ長
   - 次のメッセージ長分がPIN Block DUKPT（PINの桁数情報とXORマスクを含む）

2. **PANからアカウント番号を生成**
   - PANのチェックデジット（最後の1桁）を削除
   - `'0000' + PANの後ろ12桁`で16文字のアカウント番号を生成

3. **XOR演算でPINを取得**
   - アカウント番号（16進数）とPIN Block DUKPT（16進数）をXOR演算
   - 結果からPINの桁数分を抽出してPINを取得

##### 使用コマンド

[M2/M3] Decrypt Data Block (ECB mode)

##### 使用方法

```bash
php DecryptECBforPIN.php <PINBlock> <DecryptKey> [PAN]
```

##### パラメータ

- `PINBlock`: 暗号化されたPIN Block（16文字の16進数）
- `DecryptKey`: 復号化キー（TR-31形式のキーブロック）
- `PAN`: Primary Account Number（オプション、PIN取得時に必要）

##### 実行例

```bash
# PIN Blockのみ復号化
php DecryptECBforPIN.php 38E557F9D0C2BFEE S10096D0TN00S0000B28CA98B651D07A45310FA75C45D046C0C61439D6601D3262D9FFA804C796D1FFF050B964793A84F

# PIN Block復号化とPIN取得
php DecryptECBforPIN.php 38E557F9D0C2BFEE S10096D0TN00S0000B28CA98B651D07A45310FA75C45D046C0C61439D6601D3262D9FFA804C796D1FFF050B964793A84F 6210948000000037
```

##### 期待値

```bash
=== Decrypt ECB Tool ===
PIN Block: 38E557F9D0C2BFEE
Decrypt Key: S10096D0TN00S0000B28CA98B651D07A45310FA75C45D046C0C61439D6601D3262D9FFA804C796D1FFF050B964793A84F
PAN: 6210948000000037

Connected to HSM: tcp://192.168.8.202:1500
Send: 00001-M20011FFFS10096D0TN00S0000B28CA98B651D07A45310FA75C45D046C0C61439D6601D3262D9FFA804C796D1FFF050B964793A84F001038E557F9D0C2BFEE
Receive: 00001-M30000100A123D1E7890FFFC
Disconnected from HSM
=== RESULT ===
DUKPT復号化PINデータ: 00100A123D1E7890FFFC
PIN: 1234567890
```

##### 機能説明

- **ECB復号化**: 復号化キーで暗号化されたPIN BlockをECBモードで復号化
- **PIN取得**: PANが指定された場合、復号化されたPINデータからPINを取得（XOR処理）
- **16進数文字列入出力**: 入力・出力ともに16進数文字列形式
- **TR-31キー形式対応**: 復号化キーはTR-31形式のキーブロック形式に対応
- **0x80終端処理**: 復号化結果から0x80までのデータを抽出
- **オプション引数**: PANはオプション引数で、指定されなくてもエラーにならない

> **注意**: PIN取得には`PINUtil.php`のXOR処理を使用します。PANからアカウント番号を生成し、復号化されたPINデータとXOR演算することでPINを取得します。

#### DecryptECBwithBDK.php (M2/M3)

BDKを使用してECBモードでデータブロックを復号化するツールです。

##### 使用コマンド

[M2/M3] Decrypt Data Block (ECB mode with BDK)

##### 使用方法

```bash
php DecryptECBwithBDK.php <encryptedText> <KSN>
```

##### パラメータ

- `encryptedText`: 暗号化されたテキスト（16進数文字列）
- `KSN`: Key Serial Number

##### 実行例

```bash
php DecryptECBwithBDK.php 0BC7FE2D7E087BA40BC7FE2D7E087BA40BC7FE2D7E087BA40BC7FE2D7E087BA40BC7FE2D7E087BA4 50473030390000400000
```

##### 期待値

```
=== RESULT ===
decryptedText: 00283131313131313131313131313131313131313131
```

> **注意**: 期待値の最初の4桁（0028）が長さHEXで、続く文字列が復号化結果です。0028は16進数で40（10進数）を表し、続く文字列は40文字（20バイト）なので、長さが合っています。

##### 機能説明

- **ECB復号化**: BDKを使用してECBモードでデータブロックを復号化
- **BDK使用**: `src/property.php`の`bdk_block_3des`からBDKを取得
- **KSN対応**: DUKPT方式のKSNを使用した復号化
- **16進数文字列入出力**: 入力・出力ともに16進数文字列形式

> **注意**: `DecryptCBC.php`との違いは`modeFlag`が`'00'`(ECB)となる点のみです。BDKは`src/property.php`の`bdk_block_3des`から取得されます。

#### GenerateTMK.php (A0/A1)(mode:B)

TMK（Terminal Master Key）を生成するツールです。決済端末のマスターキーとして使用されます。

##### 使用コマンド

[A0/A1] Derive & Export a Key (mode:B)

##### 使用方法

```bash
php GenerateTMK.php
```

##### パラメータ

引数なし

##### 実行例

```bash
php GenerateTMK.php
```

##### 期待値

```
=== TMK Generation Tool ===

Connected to HSM: tcp://192.168.8.202:1500
Send: 00001-A00FFFS%00#51T2N00S00
Receive: 00001-A100S1009651TN00S0000...
Disconnected from HSM
=== RESULT ===
TMK: S1009651TN00S0000...
checkValueRightPaddedTo16Digits: ...0000000000
```

> **注意**: 生成されるTMKとチェック値は毎回異なります。上記は実行例であり、実際の出力は実行のたびに変わります。TMKはTR-31形式（`S1009651TN00S0000...`で始まる）で出力され、チェック値は16桁に右パディングされます。

##### 機能説明

- **TMK生成**: HSMを使用してTMK（Terminal Master Key）を生成
- **キー管理**: 決済端末のマスターキーとして使用
- **チェック値生成**: キーの整合性検証用のチェック値を生成
- **TR-31形式**: 標準的なキーブロック形式で出力
- **16桁パディング**: チェック値を16桁に右パディングして出力

#### GenerateMAC.php (GW/GX)

MAC（Message Authentication Code）を生成するツールです。決済データの整合性検証に使用されます。

##### 使用コマンド

[GW/GX] Generate/Verify a MAC (3DES & AES DUKPT)

##### 使用方法

```bash
php GenerateMAC.php <targetText> <KSN>
```

##### パラメータ

- `targetText`: MAC算出対象の16進数文字列（全ての項目の文字列を結合した文字列）※実際の検証はバイナリ変換されたデータが対象
- `KSN`: キーシリアル番号（20文字の16進数）

##### 実行例

```bash
php GenerateMAC.php 5047303530000220053902013886e99969ba86497106843dda0bfc5fea927e2cfb6c469e76aa5fd80d55b97f3a0a867368908de7bf6e88503518153d9b8cfabddc48d9ecb6ef6b12f602b2d3277a4be3d561681d2595c6657f6f2d1acdb75043c25998cfd2f9d5acfbecba2ed38a7a0e1835999711489b55c2301a1fc3348a40c67d4dd32859ac91dac027c573aebfac841bca2bc26a2f4796b581f18f032e8bc58854ce5a64a3c1979596a26c87fa59c60cffb043c998ec7225ef0c256a9d06a5d8e48656942e78016eb1c5e8bd002bb5b4a7798fa4a25685309ab2f18363be52e02364a2329ced208ecf644466f64893b9918f2b2e24a47761db0c70404e197f3fdf6446ff9cd081f72c11d1b16ea4a1d66290727e1238264bf89bd46025e1fc21e247d15970efe667f14e4969fa1e4d3991ccb17f9bd64ca82dfd8476679348b7800433000000355a0a621094ffffffffff152f950504c00488005f200855494343465431355f24031010315f280201569f3303e0f8c89f3403420300 50473035300002200539
```

##### 期待値

```
=== MAC Generation Tool ===
Target Text: 5047303530000220053902013886e99969ba86497106843dda0bfc5fea927e2cfb6c469e76aa5fd80d55b97f3a0a867368908de7bf6e88503518153d9b8cfabddc48d9ecb6ef6b12f602b2d3277a4be3d561681d2595c6657f6f2d1acdb75043c25998cfd2f9d5acfbecba2ed38a7a0e1835999711489b55c2301a1fc3348a40c67d4dd32859ac91dac027c573aebfac841bca2bc26a2f4796b581f18f032e8bc58854ce5a64a3c1979596a26c87fa59c60cffb043c998ec7225ef0c256a9d06a5d8e48656942e78016eb1c5e8bd002bb5b4a7798fa4a25685309ab2f18363be52e02364a2329ced208ecf644466f64893b9918f2b2e24a47761db0c70404e197f3fdf6446ff9cd081f72c11d1b16ea4a1d66290727e1238264bf89bd46025e1fc21e247d15970efe667f14e4969fa1e4d3991ccb17f9bd64ca82dfd8476679348b7800433000000355a0a621094ffffffffff152f950504c00488005f200855494343465431355f24031010315f280201569f3303e0f8c89f3403420300
KSN: 50473035300002200539

Connected to HSM: tcp://192.168.8.202:1500
Send: 00001-GW51S10096B0TN00S0000FD2196304A9F78B4844B0719E4DFBACD97ABA9E94A05EFB3BFD3F754CC626643675DE7D3A50FBE45A05504730353000022005390384PG050
Receive: 00001-GX001D69466A
Disconnected from HSM
=== RESULT ===
MAC Value: 1D69466A
```

##### 機能説明

- **MAC生成**: HSMを使用してMAC値を生成
- **データ整合性検証**: 決済データの改ざん検出に使用
- **DUKPT対応**: KSNを使用した動的キー管理に対応
- **16進数文字列対応**: 入力データは16進数文字列形式で指定

#### VerifyMAC.php (GW/GX)

MAC（Message Authentication Code）を検証するツールです。決済データの整合性を検証するために使用されます。

##### 使用コマンド

[GW/GX] Generate/Verify a MAC (3DES & AES DUKPT)

##### 使用方法

```bash
php VerifyMAC.php <macTargetData> <KSN> <MAC>
```

##### パラメータ

- `macTargetData`: MAC検証対象データ（16進数文字列）※実際の検証はバイナリ変換されたデータが対象
- `KSN`: キーシリアル番号（20文字の16進数）
- `MAC`: 検証するMAC値（16進数文字列）

##### 実行例

```bash
php VerifyMAC.php 5047303530000220053902013886e99969ba86497106843dda0bfc5fea927e2cfb6c469e76aa5fd80d55b97f3a0a867368908de7bf6e88503518153d9b8cfabddc48d9ecb6ef6b12f602b2d3277a4be3d561681d2595c6657f6f2d1acdb75043c25998cfd2f9d5acfbecba2ed38a7a0e1835999711489b55c2301a1fc3348a40c67d4dd32859ac91dac027c573aebfac841bca2bc26a2f4796b581f18f032e8bc58854ce5a64a3c1979596a26c87fa59c60cffb043c998ec7225ef0c256a9d06a5d8e48656942e78016eb1c5e8bd002bb5b4a7798fa4a25685309ab2f18363be52e02364a2329ced208ecf644466f64893b9918f2b2e24a47761db0c70404e197f3fdf6446ff9cd081f72c11d1b16ea4a1d66290727e1238264bf89bd46025e1fc21e247d15970efe667f14e4969fa1e4d3991ccb17f9bd64ca82dfd8476679348b7800433000000355a0a621094ffffffffff152f950504c00488005f200855494343465431355f24031010315f280201569f3303e0f8c89f3403420300 50473035300002200539 1D69466A
```

##### 期待値

```
=== MAC Verification Tool ===
MAC Target Data: 5047303530000220053902013886e99969ba86497106843dda0bfc5fea927e2cfb6c469e76aa5fd80d55b97f3a0a867368908de7bf6e88503518153d9b8cfabddc48d9ecb6ef6b12f602b2d3277a4be3d561681d2595c6657f6f2d1acdb75043c25998cfd2f9d5acfbecba2ed38a7a0e1835999711489b55c2301a1fc3348a40c67d4dd32859ac91dac027c573aebfac841bca2bc26a2f4796b581f18f032e8bc58854ce5a64a3c1979596a26c87fa59c60cffb043c998ec7225ef0c256a9d06a5d8e48656942e78016eb1c5e8bd002bb5b4a7798fa4a25685309ab2f18363be52e02364a2329ced208ecf644466f64893b9918f2b2e24a47761db0c70404e197f3fdf6446ff9cd081f72c11d1b16ea4a1d66290727e1238264bf89bd46025e1fc21e247d15970efe667f14e4969fa1e4d3991ccb17f9bd64ca82dfd8476679348b7800433000000355a0a621094ffffffffff152f950504c00488005f200855494343465431355f24031010315f280201569f3303e0f8c89f3403420300
KSN: 50473035300002200539
MAC: 1D69466A

Connected to HSM: tcp://192.168.8.202:1500
Send: 00001-GW21S10096B0TN00S0000FD2196304A9F78B4844B0719E4DFBACD97ABA9E94A05EFB3BFD3F754CC626643675DE7D3A50FBE45A05504730353000022005391D69466A0384PG050
Receive: 00001-GX00
Disconnected from HSM
=== RESULT ===
isVerified: Verified
```

##### 機能説明

- **MAC検証**: HSMを使用してMAC値の検証を実行
- **データ整合性検証**: 決済データの改ざん検出に使用
- **DUKPT対応**: KSNを使用した動的キー管理に対応
- **16進数文字列対応**: 入力データは16進数文字列形式で指定
- **検証結果表示**: Verified/Not Verifiedで結果を表示
